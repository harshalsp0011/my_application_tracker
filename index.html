<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Job Application Tracker</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for statistics graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light gray background */
        }
        /* Custom styles for better visual appeal */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .btn {
            padding: 0.6rem 1.2rem; /* Adjusted padding for a more compact button */
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #4b5563;
        }
         .btn-outline {
            background-color: transparent;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }
        .btn-outline:hover {
            background-color: #f9fafb;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }

        input, select {
            width: 100%;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: #f9fafb;
        }
        input:focus, select:focus {
            outline: 2px solid #4f46e5;
            border-color: transparent;
            background-color: white;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        .stat-card {
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
        }
        /* Toggle Switch and Filter Button Styles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #4f46e5;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #4f46e5;
        }
        .timeline-filter-btn.active {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
        }
        /* Make the jobs list scrollable when it grows too tall */
        #jobs-list-container {
            /* increase the visible area to reduce blank space below */
            max-height: calc(72vh - 2rem); /* leave a little room for header/footer and padding */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* smooth scrolling on iOS */
            padding-right: 0.25rem; /* small padding to avoid content touching the scrollbar */
        }
        /* Improve spacing for each job card inside the scrollable area */
        #jobs-list-container > div {
            margin-bottom: 0.5rem;
        }

        /* Responsive adjustments: smaller max-height on very small screens */
        @media (max-width: 640px) {
            #jobs-list-container {
                max-height: calc(65vh - 2rem);
            }
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-7xl mx-auto">
        
        <div class="flex justify-between items-center mb-6">
            <header class="text-left">
                <h1 class="text-4xl font-bold text-gray-800">Job Application Tracker</h1>
                <p class="text-lg text-gray-600 mt-2">Track your career journey, one application at a time.</p>
            </header>
             <div id="user-profile" class="flex items-center gap-3" style="display: none;">
                <img id="user-photo" class="h-10 w-10 rounded-full" alt="User profile photo">
                <div>
                    <p id="user-name" class="font-semibold text-gray-800 text-sm"></p>
                    <button id="signout_button" class="text-xs text-indigo-600 hover:underline focus:outline-none">Sign Out</button>
                </div>
            </div>
        </div>

        <div id="auth-card" class="card text-center">
            <p id="auth-status" class="text-gray-700 mb-4">Please sign in to manage your applications.</p>
            <button id="authorize_button" class="btn btn-primary">Sign In with Google</button>
        </div>

        <main id="main-content" style="display: none;" class="space-y-6">
            
            <div class="card">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">Add New Application</h2>
                <form id="add-job-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="jobName" class="block text-sm font-medium text-gray-700 mb-1">Job Name</label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 002 2H4a2 2 0 01-2-2V5zm3 1a1 1 0 000 2h.01a1 1 0 100-2H5zm2 0a1 1 0 000 2h3a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>
                                </div>
                                <input type="text" id="jobName" list="jobNameList" required class="pl-10">
                                <datalist id="jobNameList"></datalist>
                            </div>
                        </div>
                        <div>
                            <label for="jobCompany" class="block text-sm font-medium text-gray-700 mb-1">Company</label>
                             <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" /><path fill-rule="evenodd" d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm3 0a1 1 0 011-1h1a1 1 0 110 2H8a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                </div>
                                <input type="text" id="jobCompany" list="companyList" required class="pl-10">
                                <datalist id="companyList"></datalist>
                            </div>
                        </div>
                        <div>
                            <label for="applicationDate" class="block text-sm font-medium text-gray-700 mb-1">Application Date</label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                   <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                                </div>
                                <input type="date" id="applicationDate" required class="pl-10">
                            </div>
                        </div>
                        <div>
                            <label for="jobPortal" class="block text-sm font-medium text-gray-700 mb-1">Job Portal</label>
                            <div class="relative">
                                <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
                                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.022 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </div>
                                <input type="text" id="jobPortal" list="portalList" placeholder="e.g., LinkedIn" required class="pl-10">
                                <datalist id="portalList"></datalist>
                            </div>
                        </div>
                        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                            <div class="md:col-span-1">
                                <label for="jobStatus" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                <select id="jobStatus" required class="pl-3 pr-10">
                                    <option value="Applied">Applied</option>
                                    <option value="Interviewed">Interviewed</option>
                                    <option value="Offer">Offer</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="md:col-span-2 flex justify-end gap-4">
                                 <button type="button" id="clear-form-btn" class="btn btn-outline">Clear Form</button>
                                 <button type="submit" class="btn btn-primary">Add Application</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-1">
                    <div class="card h-full space-y-6">
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Statistics</h2>
                             <div id="stats-container" class="grid grid-cols-2 gap-4">
                                <!-- Stat blocks will be inserted here -->
                            </div>
                        </div>
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Portal Distribution</h2>
                             <canvas id="portalChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-2 card">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                        <h2 class="text-2xl font-semibold text-gray-800">My Applications</h2>
                        <div class="relative w-full md:w-1/2 lg:w-2/3">
                            <input type="search" id="search-bar" placeholder="Search..." class="w-full pl-4 pr-10">
                             <button id="refresh-button" class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-indigo-600">
                                <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566z" clip-rule="evenodd" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="loader" class="text-center p-8">
                        <p class="text-gray-600">Loading data...</p>
                    </div>
                    <div id="jobs-list-container" class="space-y-2">
                        <!-- Job cards will be inserted here by JavaScript -->
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Application Timeline</h2>
                    <div class="flex items-center gap-4">
                        <!-- Toggle Switch -->
                        <div class="flex items-center">
                            <label for="cumulative-toggle" class="text-sm font-medium text-gray-700 mr-2">Cumulative</label>
                            <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                <input type="checkbox" name="cumulative-toggle" id="cumulative-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                                <label for="cumulative-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                            </div>
                        </div>
                        <!-- Filter Buttons -->
                        <div id="timeline-filters" class="flex items-center border border-gray-300 rounded-lg overflow-hidden">
                             <button data-range="30" class="timeline-filter-btn px-3 py-1 text-sm text-gray-600 hover:bg-gray-100">30D</button>
                             <button data-range="90" class="timeline-filter-btn px-3 py-1 text-sm text-gray-600 border-l border-r hover:bg-gray-100">90D</button>
                             <button data-range="all" class="timeline-filter-btn px-3 py-1 text-sm text-gray-600 hover:bg-gray-100 active">All</button>
                        </div>
                    </div>
                </div>
                <canvas id="timelineChart"></canvas>
            </div>
        </main>
    </div>

    <!-- Deletion Confirmation Modal -->
    <div id="delete-modal" class="modal-backdrop" style="display: none;">
        <div class="modal-content">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Confirm Deletion</h3>
            <p class="text-sm text-gray-600 mb-6">Are you sure you want to delete this application? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete-btn" class="btn btn-secondary">Cancel</button>
                <button id="confirm-delete-btn" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>

    <script>
        // ===================================================================================
        // USER CONFIGURATION SECTION
        // ===================================================================================
        const CLIENT_ID = '198471139425-3epb4ocoru5jsacirk9261lbs3k9tkjc.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyCa5BQOpv_OAcxR9ulbk46SJo_rtcpRZjM';
        const SPREADSHEET_ID = '1jCoqznVtUzA6ov6OKnRYLWB2nu6d-Fpmo2n_hSpfuLw';
        const RANGE = 'Sheet1!A:G';

        // ===================================================================================
        // APPLICATION LOGIC
        // ===================================================================================

        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const authCard = document.getElementById('auth-card');
        const mainContent = document.getElementById('main-content');
        const addJobForm = document.getElementById('add-job-form');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const refreshButton = document.getElementById('refresh-button');
        const loader = document.getElementById('loader');
        const jobsListContainer = document.getElementById('jobs-list-container');
        const searchBar = document.getElementById('search-bar');
        const deleteModal = document.getElementById('delete-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cumulativeToggle = document.getElementById('cumulative-toggle');
        const timelineFiltersContainer = document.getElementById('timeline-filters');
        const userProfileDiv = document.getElementById('user-profile');
        const userNameP = document.getElementById('user-name');
        const userPhotoImg = document.getElementById('user-photo');

        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let portalChart, timelineChart;
        let rowToDelete = null;
        let allJobsData = [];
        let timelineFilter = 'all';
        let isCumulative = false;


        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.profile',
                callback: tokenCallback,
            });
            gisInited = true;
            trySilentAuth();
        }

        function gapiLoaded() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4", "https://people.googleapis.com/$discovery/rest?version=v1"],
                }).then(() => {
                    gapiInited = true;
                    trySilentAuth();
                });
            });
        }

        function trySilentAuth() {
            if (gapiInited && gisInited) {
                tokenClient.requestAccessToken({ prompt: 'none' });
            }
        }

        async function tokenCallback(resp) {
            if (resp.error !== undefined) {
                updateSigninStatus(false);
                return;
            }
            updateSigninStatus(true);
            await displayUserProfile();
            await fetchAndRenderJobs();
        }

        function handleAuthClick() {
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateSigninStatus(false);
            }
        }
        
        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                authCard.style.display = 'none';
                userProfileDiv.style.display = 'flex';
                mainContent.style.display = 'block';
            } else {
                authCard.style.display = 'block';
                userProfileDiv.style.display = 'none';
                mainContent.style.display = 'none';
            }
        }

        async function displayUserProfile() {
            try {
                const response = await gapi.client.people.people.get({
                    resourceName: 'people/me',
                    personFields: 'names,photos',
                });
                const profile = response.result;
                const primaryName = profile.names && profile.names.length > 0 ? profile.names[0].givenName : 'User';
                const primaryPhoto = profile.photos && profile.photos.length > 0 ? profile.photos[0].url : `https://placehold.co/40x40/E0E7FF/4F46E5?text=${primaryName.charAt(0)}`;

                userNameP.textContent = `Hello, ${primaryName}!`;
                userPhotoImg.src = primaryPhoto;

            } catch (err) {
                console.error("Error fetching user profile:", err);
                userNameP.textContent = 'Hello, User!';
                userPhotoImg.src = 'https://placehold.co/40x40/E0E7FF/4F46E5?text=U';
            }
        }
        
        async function fetchAndRenderJobs() {
            loader.style.display = 'block';
            jobsListContainer.innerHTML = '';
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: RANGE,
                });
                const range = response.result;
                if (range.values && range.values.length > 1) {
                    allJobsData = range.values.slice(1).map((row, index) => [...row, index + 2]);
                } else {
                    allJobsData = [];
                }
            } catch (err) {
                console.error(err);
                alert('Error loading data. Check console.');
            } finally {
                loader.style.display = 'none';
                renderJobs();
                populateDatalists();
            }
        }

        // Populate datalists for jobName, company and portal from allJobsData
        function populateDatalists() {
            const jobNameList = document.getElementById('jobNameList');
            const companyList = document.getElementById('companyList');
            const portalList = document.getElementById('portalList');

            const names = new Set();
            const companies = new Set();
            const portals = new Set();

            allJobsData.forEach(row => {
                if (row[0]) names.add(row[0]);
                if (row[1]) companies.add(row[1]);
                if (row[3]) portals.add(row[3]);
            });

            // Clear existing options
            jobNameList.innerHTML = '';
            companyList.innerHTML = '';
            portalList.innerHTML = '';

            // Append options sorted alphabetically for readability
            Array.from(names).sort().forEach(n => {
                const o = document.createElement('option'); o.value = n; jobNameList.appendChild(o);
            });
            Array.from(companies).sort().forEach(c => {
                const o = document.createElement('option'); o.value = c; companyList.appendChild(o);
            });
            Array.from(portals).sort().forEach(p => {
                const o = document.createElement('option'); o.value = p; portalList.appendChild(o);
            });
        }

        function renderJobs() {
            const searchTerm = (searchBar.value || '').toLowerCase().trim();
            const filteredJobs = allJobsData.filter(row => {
                if (!searchTerm) return true; // no filter
                const jobName = (row[0] || '').toLowerCase();
                const company = (row[1] || '').toLowerCase();
                const appliedDate = (row[2] || '').toLowerCase();
                const portal = (row[3] || '').toLowerCase();
                const status = (row[4] || '').toLowerCase();
                const updatedDate = (row[5] || '').toLowerCase();
                const rowIndex = String(row[6] || '').toLowerCase();

                // match if any field contains the search term
                return jobName.includes(searchTerm)
                    || company.includes(searchTerm)
                    || appliedDate.includes(searchTerm)
                    || portal.includes(searchTerm)
                    || status.includes(searchTerm)
                    || updatedDate.includes(searchTerm)
                    || rowIndex.includes(searchTerm);
            });

            // Sort by updated date (col 5 / index 5) desc, then application date (col 2), then row index
            filteredJobs.sort((a, b) => {
                const updatedA = a[5] ? new Date(a[5]) : null;
                const updatedB = b[5] ? new Date(b[5]) : null;
                if (updatedA && updatedB) {
                    if (updatedB - updatedA !== 0) return updatedB - updatedA;
                } else if (updatedA && !updatedB) {
                    return -1; // a is newer
                } else if (!updatedA && updatedB) {
                    return 1; // b is newer
                }

                const appliedA = a[2] ? new Date(a[2]) : null;
                const appliedB = b[2] ? new Date(b[2]) : null;
                if (appliedA && appliedB) {
                    if (appliedB - appliedA !== 0) return appliedB - appliedA;
                } else if (appliedA && !appliedB) {
                    return -1;
                } else if (!appliedA && appliedB) {
                    return 1;
                }

                // Finally, fallback to sheet row index (higher index is newer entry)
                const rowIndexA = parseInt(a[6]) || 0;
                const rowIndexB = parseInt(b[6]) || 0;
                return rowIndexB - rowIndexA;
            });
            
            jobsListContainer.innerHTML = '';

            if (filteredJobs.length > 0) {
                filteredJobs.forEach(row => {
                    const sheetRowIndex = row[6];
                    const status = row[4] || 'N/A';
                    
                    let borderColorClass, selectBgClass, selectTextClass, selectBorderClass;
                     switch (status) {
                        case 'Interviewed':
                            borderColorClass = 'border-l-yellow-400';
                            selectBgClass = 'bg-yellow-100';
                            selectTextClass = 'text-yellow-800';
                            selectBorderClass = 'border-yellow-300';
                            break;
                        case 'Offer':
                            borderColorClass = 'border-l-green-400';
                            selectBgClass = 'bg-green-100';
                            selectTextClass = 'text-green-800';
                            selectBorderClass = 'border-green-300';
                            break;
                        case 'Rejected':
                            borderColorClass = 'border-l-red-400';
                            selectBgClass = 'bg-red-100';
                            selectTextClass = 'text-red-800';
                            selectBorderClass = 'border-red-300';
                            break;
                        case 'Applied':
                            borderColorClass = 'border-l-blue-400';
                            selectBgClass = 'bg-blue-100';
                            selectTextClass = 'text-blue-800';
                            selectBorderClass = 'border-blue-300';
                            break;
                        default:
                            borderColorClass = 'border-l-gray-300';
                            selectBgClass = 'bg-gray-100';
                            selectTextClass = 'text-gray-800';
                            selectBorderClass = 'border-gray-300';
                    }

                    const jobCard = document.createElement('div');
                    jobCard.className = `bg-white p-3 rounded-md shadow-sm border-l-4 ${borderColorClass}`;
                    jobCard.innerHTML = `
                        <div class="flex justify-between items-baseline text-sm">
                             <p class="font-bold text-base text-gray-900 truncate pr-4">${row[0] || 'N/A'}</p>
                             <div class="text-xs text-gray-500 flex gap-3 flex-shrink-0">
                                <p>Applied: ${row[2] || 'N/A'}</p>
                                <p>Updated: <span class="font-semibold text-gray-700">${row[5] || 'N/A'}</span></p>
                            </div>
                        </div>
                        <div class="mt-2 pt-2 border-t border-gray-200 flex justify-between items-center text-xs text-gray-500">
                            <div class="flex items-baseline gap-2">
                               <p class="text-sm text-gray-600 font-semibold">${row[1] || 'N/A'}</p>
                               <p>via ${row[3] || 'N/A'}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <select class="status-select font-semibold text-xs rounded-md p-1 border ${selectBorderClass} ${selectBgClass} ${selectTextClass}" data-row-index="${sheetRowIndex}" style="padding-right: 1.5rem;">
                                     <option value="Applied" ${status === 'Applied' ? 'selected' : ''}>Applied</option>
                                     <option value="Interviewed" ${status === 'Interviewed' ? 'selected' : ''}>Interviewed</option>
                                     <option value="Offer" ${status === 'Offer' ? 'selected' : ''}>Offer</option>
                                     <option value="Rejected" ${status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                                </select>
                                <button class="delete-btn text-gray-400 hover:text-red-600 p-1 rounded-full hover:bg-red-100" data-row-index="${sheetRowIndex}">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                 </button>
                            </div>
                        </div>
                    `;
                    jobsListContainer.appendChild(jobCard);
                });
            } else {
                jobsListContainer.innerHTML = '<p class="text-center text-gray-500 p-4">No matching applications found.</p>';
            }
            updateCharts(filteredJobs);
        }

        async function addJob(e) {
            e.preventDefault();
            const appDate = document.getElementById('applicationDate').value;
            const values = [[
                document.getElementById('jobName').value,
                document.getElementById('jobCompany').value,
                appDate,
                document.getElementById('jobPortal').value,
                document.getElementById('jobStatus').value,
                appDate
            ]];
            try {
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID, range: 'Sheet1!A:F', valueInputOption: 'USER_ENTERED',
                    resource: { values: values },
                });
                clearForm();
                await fetchAndRenderJobs();
            } catch (err) {
                console.error(err);
                alert('Error adding application. Check console for details.');
            }
        }
        
        async function updateStatus(rowIndex, newStatus) {
            const currentDate = new Date().toLocaleDateString('en-CA');
            try {
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `Sheet1!E${rowIndex}:F${rowIndex}`,
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: [[newStatus, currentDate]] },
                });
                 await fetchAndRenderJobs();
            } catch(err) {
                console.error("Error updating status:", err);
                alert("Could not update status. See console for details.");
            }
        }
        
        function handleDeleteClick(rowIndex) {
            rowToDelete = rowIndex;
            deleteModal.style.display = 'flex';
        }
        
        async function confirmDelete() {
            if (!rowToDelete) return;
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            deleteDimension: {
                                range: {
                                    sheetId: 0,
                                    dimension: 'ROWS',
                                    startIndex: rowToDelete - 1,
                                    endIndex: rowToDelete
                                }
                            }
                        }]
                    }
                });
                await fetchAndRenderJobs();
            } catch (err) {
                console.error("Error deleting row:", err);
                alert("Could not delete row. See console for details.");
            } finally {
                rowToDelete = null;
                deleteModal.style.display = 'none';
            }
        }

        function updateCharts(data) {
            // 1. Update Stat Blocks
            const statsContainer = document.getElementById('stats-container');
            const statuses = data.map(row => row[4]);
            const statusCounts = { 'Applied': 0, 'Interviewed': 0, 'Offer': 0, 'Rejected': 0, 'Total': data.length };
            
            statuses.forEach(status => {
                if (status && statusCounts.hasOwnProperty(status)) {
                    statusCounts[status]++;
                }
            });

            statsContainer.innerHTML = '';
            const statusColors = {
                'Applied': 'text-blue-600', 'Interviewed': 'text-yellow-600', 'Offer': 'text-green-600',
                'Rejected': 'text-red-600', 'Total': 'text-gray-800'
            };
            
            Object.keys(statusCounts).forEach(status => {
                if (status === 'Total') return;
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `<p class="text-2xl font-bold ${statusColors[status]}">${statusCounts[status]}</p><p class="text-sm font-medium text-gray-500">${status}</p>`;
                statsContainer.appendChild(statCard);
            });
            const totalCard = document.createElement('div');
            totalCard.className = 'stat-card col-span-2';
            totalCard.innerHTML = `<p class="text-3xl font-bold ${statusColors['Total']}">${statusCounts['Total']}</p><p class="text-base font-medium text-gray-500">Total Applications</p>`;
            statsContainer.appendChild(totalCard);

            // 2. Update Timeline Line Chart with All Features
            let timelineSourceData = data;
            if (timelineFilter !== 'all') {
                const days = parseInt(timelineFilter);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                timelineSourceData = data.filter(row => new Date(row[2]) >= cutoffDate);
            }

            const timelineData = timelineSourceData.reduce((acc, row) => {
                const appliedDate = row[2];
                const updatedDate = row[5];
                const status = row[4];
                const company = row[1] || 'Unknown';

                const processDate = (date, statusKey) => {
                    if (!date) return;
                    acc[date] = acc[date] || { applied: 0, interviewed: 0, offer: 0, rejected: 0, details: { applied: [], interviewed: [], offer: [], rejected: [] } };
                    acc[date][statusKey]++;
                    acc[date].details[statusKey].push(company);
                };

                processDate(appliedDate, 'applied');
                if (status === 'Interviewed') processDate(updatedDate, 'interviewed');
                if (status === 'Offer') processDate(updatedDate, 'offer');
                if (status === 'Rejected') processDate(updatedDate, 'rejected');

                return acc;
            }, {});

            const sortedDates = Object.keys(timelineData).sort((a, b) => new Date(a) - new Date(b));
            
            let appliedCounts = sortedDates.map(date => timelineData[date].applied || 0);
            let interviewedCounts = sortedDates.map(date => timelineData[date].interviewed || 0);
            let offerCounts = sortedDates.map(date => timelineData[date].offer || 0);
            let rejectedCounts = sortedDates.map(date => timelineData[date].rejected || 0);

            if (isCumulative) {
                const toCumulative = arr => arr.reduce((a, b, i) => a.concat((b + (a[i - 1] || 0))), []);
                appliedCounts = toCumulative(appliedCounts);
                interviewedCounts = toCumulative(interviewedCounts);
                offerCounts = toCumulative(offerCounts);
                rejectedCounts = toCumulative(rejectedCounts);
            }

            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            if(timelineChart) timelineChart.destroy();
            timelineChart = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: sortedDates,
                    datasets: [
                        { label: 'Applied', data: appliedCounts, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.3 },
                        { label: 'Interviewed', data: interviewedCounts, borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.1)', fill: true, tension: 0.3 },
                        { label: 'Offer', data: offerCounts, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.3 },
                        { label: 'Rejected', data: rejectedCounts, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: { 
                    scales: { y: { beginAtZero: true } }, 
                    plugins: { 
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                footer: (tooltipItems) => {
                                    const footerLines = new Set();
                                    tooltipItems.forEach(item => {
                                        const date = item.label;
                                        const datasetLabel = item.dataset.label.toLowerCase();
                                        const companies = timelineData[date]?.details[datasetLabel];
                                        if (companies && companies.length) {
                                            footerLines.add(`${item.dataset.label}: ${companies.join(', ')}`);
                                        }
                                    });
                                    return Array.from(footerLines);
                                }
                            }
                        }
                    } 
                }
            });

            // 3. Update Portal Pie Chart
            const portals = data.map(row => row[3]);
            const portalCounts = portals.reduce((acc, portal) => {
                if(portal) { acc[portal] = (acc[portal] || 0) + 1; }
                return acc;
            }, {});

            const pieColors = ['#4f46e5', '#818cf8', '#a5b4fc', '#c7d2fe', '#e0e7ff', '#f59e0b', '#fcd34d', '#fef08a', '#10b981', '#6ee7b7', '#a7f3d0'];

            const portalCtx = document.getElementById('portalChart').getContext('2d');
            if(portalChart) portalChart.destroy();
            portalChart = new Chart(portalCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(portalCounts),
                    datasets: [{
                        label: 'Applications',
                        data: Object.values(portalCounts),
                        backgroundColor: pieColors,
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        function clearForm() {
            addJobForm.reset();
            document.getElementById('applicationDate').valueAsDate = new Date();
        }

        window.onload = () => {
            const gapiScript = document.createElement('script');
            gapiScript.src = 'https://apis.google.com/js/api.js';
            gapiScript.async = true; gapiScript.defer = true;
            gapiScript.onload = gapiLoaded;
            document.body.appendChild(gapiScript);

            const gisScript = document.createElement('script');
            gisScript.src = 'https://accounts.google.com/gsi/client';
            gisScript.async = true; gisScript.defer = true;
            gisScript.onload = gisLoaded;
            document.body.appendChild(gisScript);
            
            clearForm();
        };

        authorizeButton.onclick = handleAuthClick;
        signoutButton.onclick = handleSignoutClick;
        addJobForm.addEventListener('submit', addJob);
        clearFormBtn.addEventListener('click', clearForm);
        refreshButton.addEventListener('click', fetchAndRenderJobs);
        searchBar.addEventListener('input', renderJobs);
        
        cumulativeToggle.addEventListener('change', (e) => {
            isCumulative = e.target.checked;
            renderJobs(); 
        });

        timelineFiltersContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('timeline-filter-btn')) {
                timelineFiltersContainer.querySelector('.active').classList.remove('active');
                e.target.classList.add('active');
                timelineFilter = e.target.dataset.range;
                renderJobs();
            }
        });
        
        jobsListContainer.addEventListener('change', (e) => {
            if (e.target.classList.contains('status-select')) {
                updateStatus(e.target.dataset.rowIndex, e.target.value);
            }
        });
        
        jobsListContainer.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                handleDeleteClick(deleteButton.dataset.rowIndex);
            }
        });

        cancelDeleteBtn.onclick = () => {
            deleteModal.style.display = 'none';
            rowToDelete = null;
        };
        confirmDeleteBtn.onclick = confirmDelete;
    </script>
</body>
</html>

